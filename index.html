<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruitment Dashboard - CSV Enabled</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }

        .dashboard-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .dashboard-header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* CSV Upload Section */
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .upload-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #d0d7ff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        #csvFileInput {
            display: none;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #764ba2;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 6px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .kpi-card h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .kpi-change {
            font-size: 0.85em;
            color: #28a745;
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .chart-wrapper.tall {
            height: 400px;
        }

        .chart-wrapper.extra-tall {
            height: 500px;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .filter-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            background: white;
        }

        .filter-group button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .filter-group button:hover {
            background: #764ba2;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
        }

        .loading.show {
            display: block;
        }

        .empty-message {
            text-align: center;
            padding: 50px;
            color: #999;
        }

        .empty-message p:first-child {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        @media (max-width: 768px) {
            .chart-container {
                grid-template-columns: 1fr;
            }

            .dashboard-header h1 {
                font-size: 1.8em;
            }

            .kpi-container {
                grid-template-columns: 1fr;
            }
        }

        /* Raw Data Table Styles */
        .data-table-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .data-table-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 1em;
        }

        .search-box:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .table-info {
            color: #666;
            font-size: 0.9em;
        }

        .data-table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #rawDataTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        #rawDataTable thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #667eea;
        }

        #rawDataTable th {
            background: #667eea;
            color: white;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        #rawDataTable th:hover {
            background: #5568d3;
        }

        #rawDataTable th::after {
            content: ' ‚áÖ';
            opacity: 0.5;
            font-size: 0.8em;
        }

        #rawDataTable th.sort-asc::after {
            content: ' √¢‚Äì¬≤';
            opacity: 1;
        }

        #rawDataTable th.sort-desc::after {
            content: ' √¢‚Äì¬º';
            opacity: 1;
        }

        #rawDataTable td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #rawDataTable tbody tr {
            transition: background-color 0.2s ease;
        }

        #rawDataTable tbody tr:hover {
            background-color: #f8f9ff;
        }

        #rawDataTable tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        #rawDataTable tbody tr:nth-child(even):hover {
            background-color: #f8f9ff;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-scheduled {
            background: #fff3cd;
            color: #856404;
        }

        .status-done {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-default {
            background: #e7e7e7;
            color: #333;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-buttons button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .pagination-buttons button:hover:not(:disabled) {
            background: #764ba2;
        }

        .pagination-buttons button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #666;
            font-size: 0.9em;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rows-per-page select {
            padding: 6px 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="dashboard-header">
        <h1>üéØ Recruitment Dashboard</h1>
        <p>Upload your CSV to see real-time insights</p>
    </div>

    <!-- CSV Upload Section -->
    <div class="upload-section">
        <h3>üìÇ Upload Your Candidate CSV File</h3>
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìä</div>
            <p><strong>Drag and drop your CSV file here</strong></p>
            <p>or</p>
            <button class="upload-btn" onclick="document.getElementById('csvFileInput').click()">
                Choose File
            </button>
            <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileSelect(event)">
        </div>
        <div class="file-info" id="fileInfo">
            <strong>‚úÖ File loaded successfully!</strong>
            <p id="fileDetails"></p>
        </div>
    </div>

    <div class="loading" id="loading">
        <p>‚è≥ Processing your data...</p>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-container" id="kpiContainer">
        <div class="kpi-card">
            <h3>Total Candidates</h3>
            <div class="kpi-value" id="totalCandidates">-</div>
            <div class="kpi-change">Upload CSV to see data</div>
        </div>
        <div class="kpi-card">
            <h3>Active Pipeline</h3>
            <div class="kpi-value" id="activePipeline">-</div>
            <div class="kpi-change">Upload CSV to see data</div>
        </div>
        <div class="kpi-card">
            <h3>Interviews Scheduled</h3>
            <div class="kpi-value" id="interviewsScheduled">-</div>
            <div class="kpi-change">Upload CSV to see data</div>
        </div>
        <div class="kpi-card">
            <h3>Trials Scheduled</h3>
            <div class="kpi-value" id="trialsScheduled">-</div>
            <div class="kpi-change">Upload CSV to see data</div>
        </div>
        <div class="kpi-card">
            <h3>Confirmed Candidates</h3>
            <div class="kpi-value" id="confirmedCandidates">-</div>
            <div class="kpi-change">Upload CSV to see data</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <h3>üìä Filter Dashboard</h3>
        <div class="filter-group">
            <select id="jobFilter">
                <option value="all">All Job Titles</option>
            </select>
            <select id="statusFilter">
                <option value="all">All Statuses</option>
            </select>
            <select id="qualificationFilter">
                <option value="all">All Qualifications</option>
            </select>
            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="resetFilters()">Reset</button>
            <button onclick="exportData()">üì• Export Data</button>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-container">
        <div class="chart-card full-width">
            <h2>üìà Recruitment Pipeline - Status Distribution</h2>
            <div class="chart-wrapper extra-tall">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h2>üéØ Source Performance</h2>
            <div class="chart-wrapper">
                <canvas id="sourceChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h2>üíº Top Job Titles</h2>
            <div class="chart-wrapper">
                <canvas id="jobTitleChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h2>üë• Age Distribution</h2>
            <div class="chart-wrapper">
                <canvas id="ageChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h2>üéì Qualification Levels</h2>
            <div class="chart-wrapper">
                <canvas id="qualificationChart"></canvas>
            </div>
        </div>

        <div class="chart-card full-width">
            <h2>üí∞ Salary Range Analysis</h2>
            <div class="chart-wrapper tall" id="salaryChartWrapper">
                <canvas id="salaryChart"></canvas>
            </div>
        </div>

        <!-- Salary Data Table -->
        <div class="chart-card full-width" id="salaryTableCard" style="display: none;">
            <h2>üíµ Detailed Salary Data</h2>
            <div style="overflow-x: auto;">
                <table id="salaryTable">
                    <thead>
                        <tr>
                            <th>Job Title</th>
                            <th style="text-align: right;">Candidates</th>
                            <th style="text-align: right;">Min Salary</th>
                            <th style="text-align: right;">Avg Salary</th>
                            <th style="text-align: right;">Max Salary</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Raw Data Table Section -->
    <div class="data-table-section full-width" id="rawDataSection" style="display: none;">
        <h2>üìã All Candidate Data</h2>

        <div class="table-controls">
            <input type="text" id="searchInput" class="search-box"
                placeholder="üîç Search by name, job title, status, phone..." onkeyup="searchTable()">
            <div class="rows-per-page">
                <label>Rows per page:</label>
                <select id="rowsPerPage" onchange="changeRowsPerPage()">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="all">All</option>
                </select>
            </div>
            <span class="table-info" id="tableInfo">No data loaded</span>
        </div>

        <div class="data-table-wrapper">
            <table id="rawDataTable">
                <thead id="tableHeader">
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="100" class="no-data-message">
                            Upload a CSV file to view candidate data
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-controls" id="paginationControls" style="display: none;">
            <div class="pagination-info" id="paginationInfo"></div>
            <div class="pagination-buttons">
                <button onclick="changePage('first')">¬´ First</button>
                <button onclick="changePage('prev')">‚Äπ Previous</button>
                <button onclick="changePage('next')">Next ‚Ä∫</button>
                <button onclick="changePage('last')">Last ¬ª</button>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let originalCsvData = [];
        let charts = {};

        // DEFINED STATUS ORDER - This is the master order for all filters and charts
        const STATUS_ORDER = [
            'Select',
            'Rejected Profile',
            'Phone Not Received',
            'Telephonic Done',
            'Job Application Received',
            'Pre-Interview Scheduled',
            'Pre-Interview Done',
            'Interview Scheduled',
            'Interview Done',
            'Trial Scheduled',
            'Offer Given',
            'Trial Done',
            'Confirm Candidate',
            'Rejected by Company',
            'Rejected by Candidate',
            'Onboarding Done',
            'Training Done',
            'Call on Top Priority'
        ];

        const chartColors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#28a745',
            warning: '#ffc107',
            danger: '#dc3545',
            info: '#17a2b8',
            gradient: [
                '#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b',
                '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#fed6e3',
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
                '#dfe6e9', '#74b9ff', '#a29bfe'
            ]
        };

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                parseCSV(file);
            } else {
                alert('Please upload a valid CSV file');
            }
        });

        // File select handler
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                parseCSV(file);
            }
        }

        // Parse CSV file
        function parseCSV(file) {
            document.getElementById('loading').classList.add('show');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    csvData = results.data;
                    originalCsvData = [...csvData];
                    document.getElementById('loading').classList.remove('show');

                    // Debug: Log sample salary data
                    console.log('Sample salary values:', csvData.slice(0, 10).map(row => ({
                        job: row['JOB TITLE'],
                        salary: row['Past salary']
                    })));

                    // Show file info
                    const fileInfo = document.getElementById('fileInfo');
                    const fileDetails = document.getElementById('fileDetails');
                    fileDetails.innerHTML = `
                        File: <strong>${file.name}</strong><br>
                        Rows: <strong>${csvData.length}</strong><br>
                        Columns: <strong>${Object.keys(csvData[0] || {}).length}</strong>
                    `;
                    fileInfo.classList.add('show');

                    // Process and display data
                    processData();
                },
                error: function (error) {
                    document.getElementById('loading').classList.remove('show');
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        // Process CSV data and update dashboard
        function processData() {
            if (csvData.length === 0) return;

            // Update KPIs
            updateKPIs();

            // Update filters
            updateFilters();

            // Create/Update charts
            createCharts();
        }

        function updateKPIs() {
            // Total Candidates
            document.getElementById('totalCandidates').textContent = csvData.length;

            // Active Pipeline (exclude rejected and confirmed)
            const activeStatuses = csvData.filter(row => {
                const status = (row.STATUS || '').trim();
                return !status.includes('Rejected') &&
                    !status.includes('Confirm') &&
                    status !== 'Select' &&
                    status !== '';
            });
            document.getElementById('activePipeline').textContent = activeStatuses.length;

            // Interviews Scheduled
            const interviews = csvData.filter(row => {
                const status = (row.STATUS || '').trim();
                return status === 'Interview Scheduled' || status === 'Pre-Interview Scheduled';
            });
            document.getElementById('interviewsScheduled').textContent = interviews.length;

            // Trials Scheduled
            const trials = csvData.filter(row => {
                const status = (row.STATUS || '').trim();
                return status === 'Trial Scheduled';
            });
            document.getElementById('trialsScheduled').textContent = trials.length;

            // Confirmed Candidates
            const confirmed = csvData.filter(row => {
                const status = (row.STATUS || '').trim();
                return status === 'Confirm Candidate';
            });
            document.getElementById('confirmedCandidates').textContent = confirmed.length;
        }

        function updateFilters() {
            // Job Title Filter
            const jobFilter = document.getElementById('jobFilter');
            const uniqueJobs = [...new Set(csvData.map(row => row['JOB TITLE']).filter(Boolean))];
            uniqueJobs.sort();
            jobFilter.innerHTML = '<option value="all">All Job Titles</option>';
            uniqueJobs.forEach(job => {
                jobFilter.innerHTML += `<option value="${job}">${job}</option>`;
            });

            // Status Filter - USE DEFINED ORDER
            const statusFilter = document.getElementById('statusFilter');
            const uniqueStatuses = [...new Set(csvData.map(row => (row.STATUS || '').trim()).filter(Boolean))];

            // Filter statuses to only include those in STATUS_ORDER
            const orderedStatuses = STATUS_ORDER.filter(status => uniqueStatuses.includes(status));

            statusFilter.innerHTML = '<option value="all">All Statuses</option>';
            orderedStatuses.forEach(status => {
                statusFilter.innerHTML += `<option value="${status}">${status}</option>`;
            });

            // Qualification Filter
            const qualFilter = document.getElementById('qualificationFilter');
            const uniqueQuals = [...new Set(csvData.map(row => row.QUALIFICATION).filter(Boolean))];
            uniqueQuals.sort();
            qualFilter.innerHTML = '<option value="all">All Qualifications</option>';
            uniqueQuals.forEach(qual => {
                qualFilter.innerHTML += `<option value="${qual}">${qual}</option>`;
            });
        }

        function createCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // 1. Status Distribution - ORDERED BY STATUS_ORDER
            const statusCounts = {};
            csvData.forEach(row => {
                const status = (row.STATUS || '').trim();
                if (status) {
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                }
            });

            // Order the statuses according to STATUS_ORDER
            const orderedStatusLabels = STATUS_ORDER.filter(status => statusCounts[status] > 0);
            const orderedStatusData = orderedStatusLabels.map(status => statusCounts[status]);

            // Assign colors based on status type
            const statusColors = orderedStatusLabels.map(status => {
                if (status.includes('Rejected') || status === 'Phone Not Received') return '#dc3545';
                if (status === 'Confirm Candidate' || status === 'Onboarding Done' || status === 'Training Done') return '#28a745';
                if (status.includes('Scheduled') || status === 'Call on Top Priority') return '#ffc107';
                if (status.includes('Done') || status === 'Offer Given') return '#17a2b8';
                return '#667eea';
            });

            charts.status = new Chart(document.getElementById('statusChart'), {
                type: 'bar',
                data: {
                    labels: orderedStatusLabels,
                    datasets: [{
                        label: 'Number of Candidates',
                        data: orderedStatusData,
                        backgroundColor: statusColors,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = orderedStatusData.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                                    return `${context.parsed.x} candidates (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // 2. Source Performance
            const sourceCounts = {};
            csvData.forEach(row => {
                const source = row['WHERE DID YOU HEAR ABOUT US?'] || 'Unknown';
                sourceCounts[source] = (sourceCounts[source] || 0) + 1;
            });

            // Sort by count descending
            const sortedSources = Object.entries(sourceCounts)
                .sort((a, b) => b[1] - a[1]);

            charts.source = new Chart(document.getElementById('sourceChart'), {
                type: 'doughnut',
                data: {
                    labels: sortedSources.map(s => s[0]),
                    datasets: [{
                        data: sortedSources.map(s => s[1]),
                        backgroundColor: chartColors.gradient,
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 15, padding: 10, font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = sortedSources.reduce((sum, s) => sum + s[1], 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 3. Job Titles (Top 10)
            const jobCounts = {};
            csvData.forEach(row => {
                const job = row['JOB TITLE'] || 'Unknown';
                jobCounts[job] = (jobCounts[job] || 0) + 1;
            });

            const topJobs = Object.entries(jobCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            charts.jobs = new Chart(document.getElementById('jobTitleChart'), {
                type: 'bar',
                data: {
                    labels: topJobs.map(j => j[0]),
                    datasets: [{
                        label: 'Candidates',
                        data: topJobs.map(j => j[1]),
                        backgroundColor: chartColors.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.parsed.x} candidates`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // 4. Age Distribution
            const ageRanges = { '18-22': 0, '23-27': 0, '28-32': 0, '33-37': 0, '38-42': 0, '43+': 0 };
            csvData.forEach(row => {
                const age = parseInt(row.AGE);
                if (!isNaN(age)) {
                    if (age <= 22) ageRanges['18-22']++;
                    else if (age <= 27) ageRanges['23-27']++;
                    else if (age <= 32) ageRanges['28-32']++;
                    else if (age <= 37) ageRanges['33-37']++;
                    else if (age <= 42) ageRanges['38-42']++;
                    else ageRanges['43+']++;
                }
            });

            charts.age = new Chart(document.getElementById('ageChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(ageRanges),
                    datasets: [{
                        label: 'Candidates',
                        data: Object.values(ageRanges),
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: chartColors.primary,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: chartColors.primary,
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // 5. Qualifications
            const qualCounts = {};
            csvData.forEach(row => {
                const qual = row.QUALIFICATION || 'Unknown';
                qualCounts[qual] = (qualCounts[qual] || 0) + 1;
            });

            charts.qual = new Chart(document.getElementById('qualificationChart'), {
                type: 'polarArea',
                data: {
                    labels: Object.keys(qualCounts),
                    datasets: [{
                        data: Object.values(qualCounts),
                        backgroundColor: chartColors.gradient.map(c => c + '80'),
                        borderColor: chartColors.gradient,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 15, padding: 10, font: { size: 11 } }
                        }
                    }
                }
            });

            // 6. Salary Analysis by Job Title - IMPROVED VERSION
            const salaryByJob = {};
            let totalSalaryEntries = 0;

            csvData.forEach(row => {
                const job = row['JOB TITLE'];
                const salaryStr = (row['Past salary'] || '').toString();

                // Try multiple parsing methods
                let salary = 0;

                // Remove all non-numeric characters except decimal point
                const cleanSalary = salaryStr.replace(/[^0-9.]/g, '');
                salary = parseFloat(cleanSalary);

                // If still no valid salary, try comma as decimal separator
                if (isNaN(salary) || salary === 0) {
                    const commaDecimal = salaryStr.replace(/[^0-9,]/g, '').replace(',', '.');
                    salary = parseFloat(commaDecimal);
                }

                if (job && job.trim() !== '' && !isNaN(salary) && salary > 0 && salary < 10000000) {
                    if (!salaryByJob[job]) salaryByJob[job] = [];
                    salaryByJob[job].push(salary);
                    totalSalaryEntries++;
                }
            });

            console.log('Salary entries found:', totalSalaryEntries);
            console.log('Jobs with salary data:', Object.keys(salaryByJob).length);

            // Check if we have any salary data
            const hasValidSalaryData = Object.keys(salaryByJob).length > 0;

            if (hasValidSalaryData) {
                const salaryData = Object.entries(salaryByJob)
                    .filter(([job, salaries]) => salaries.length >= 2)
                    .sort((a, b) => b[1].length - a[1].length)
                    .slice(0, 10)
                    .map(([job, salaries]) => ({
                        job: job,
                        min: Math
                            .min(...salaries),
                        avg: salaries.reduce((a, b) => a + b) / salaries.length,
                        max: Math.max(...salaries),
                        count: salaries.length
                    }));
                if (salaryData.length > 0) {
                    charts.salary = new Chart(document.getElementById('salaryChart'), {
                        type: 'bar',
                        data: {
                            labels: salaryData.map(d => d.job),
                            datasets: [
                                {
                                    label: 'Minimum Salary',
                                    data: salaryData.map(d => d.min),
                                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                                    borderColor: chartColors.danger,
                                    borderWidth: 1
                                },
                                {
                                    label: 'Average Salary',
                                    data: salaryData.map(d => d.avg),
                                    backgroundColor: 'rgba(102, 126, 234, 0.7)',
                                    borderColor: chartColors.primary,
                                    borderWidth: 1
                                },
                                {
                                    label: 'Maximum Salary',
                                    data: salaryData.map(d => d.max),
                                    backgroundColor: 'rgba(40, 167, 69, 0.7)',
                                    borderColor: chartColors.success,
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        title: function (context) {
                                            const index = context[0].dataIndex;
                                            return `${salaryData[index].job} (${salaryData[index].count} candidates)`;
                                        },
                                        label: function (context) {
                                            return context.dataset.label + ': ‚Çπ' + Math.round(context.parsed.y).toLocaleString('en-IN');
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        autoSkip: false,
                                        maxRotation: 45,
                                        minRotation: 45,
                                        font: { size: 10 }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            if (value >= 100000) {
                                                return '‚Çπ' + (value / 100000).toFixed(1) + 'L';
                                            }
                                            return '‚Çπ' + (value / 1000).toFixed(0) + 'K';
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // Populate salary table
                    document.getElementById('salaryTableCard').style.display = 'block';
                    const tbody = document.getElementById('salaryTableBody');
                    tbody.innerHTML = '';

                    salaryData.forEach((d, index) => {
                        const row = tbody.insertRow();
                        row.style.background = index % 2 === 0 ? '#f8f9ff' : 'white';
                        row.innerHTML = `
                        <td>${d.job}</td>
                        <td style="text-align: right;">${d.count}</td>
                        <td style="text-align: right;">‚Çπ${Math.round(d.min).toLocaleString('en-IN')}</td>
                        <td style="text-align: right;">‚Çπ${Math.round(d.avg).toLocaleString('en-IN')}</td>
                        <td style="text-align: right;">‚Çπ${Math.round(d.max).toLocaleString('en-IN')}</td>
                    `;
                    });
                } else {
                    document.getElementById('salaryChartWrapper').innerHTML =
                        '<div class="empty-message">' +
                        '<p>üìä Insufficient Salary Data</p>' +
                        '<p>Need at least 2 candidates per job title with valid salary information</p>' +
                        '<p style="margin-top: 15px;">Found ' + totalSalaryEntries + ' salary entries across ' + Object.keys(salaryByJob).length + ' job titles</p>' +
                        '</div>';
                }
            } else {
                document.getElementById('salaryChartWrapper').innerHTML =
                    '<div class="empty-message">' +
                    '<p>üí∞ No Salary Information Found</p>' +
                    '<p>The "Past salary" column appears to be empty or contains invalid data</p>' +
                    '<p style="margin-top: 10px; font-size: 0.9em;">Accepted formats: 50000, 50,000, 50000.00, ‚Çπ50000</p>' +
                    '</div>';
            }
        }

        function applyFilters() {
            const jobFilter = document.getElementById('jobFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const qualFilter = document.getElementById('qualificationFilter').value;

            csvData = [...originalCsvData];

            if (jobFilter !== 'all') {
                csvData = csvData.filter(row => row['JOB TITLE'] === jobFilter);
            }
            if (statusFilter !== 'all') {
                csvData = csvData.filter(row => (row.STATUS || '').trim() === statusFilter);
            }
            if (qualFilter !== 'all') {
                csvData = csvData.filter(row => row.QUALIFICATION === qualFilter);
            }

            processData();

            alert(`‚úÖ Filters Applied!\nShowing ${csvData.length} of ${originalCsvData.length} candidates`);
        }

        function resetFilters() {
            document.getElementById('jobFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('qualificationFilter').value = 'all';

            csvData = [...originalCsvData];
            processData();
        }

        function exportData() {
            if (csvData.length === 0) {
                alert('Please upload CSV data first!');
                return;
            }

            const headers = Object.keys(csvData[0]);
            let csvContent = headers.join(',') + '\n';

            csvData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value}"`;
                });
                csvContent += values.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `filtered_candidates_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        // Raw Data Table Variables
        let currentPage = 1;
        let rowsPerPage = 50;
        let sortColumn = null;
        let sortDirection = 'asc';
        let filteredData = [];

        // Display Raw Data Table
        function displayRawDataTable() {
            if (csvData.length === 0) return;

            // Show the section
            document.getElementById('rawDataSection').style.display = 'block';

            filteredData = [...csvData];

            // Get all column headers
            const headers = Object.keys(csvData[0]);

            // Create table header
            const tableHeader = document.getElementById('tableHeader');
            tableHeader.innerHTML = '<tr>' +
                headers.map(header => `<th onclick="sortTable('${header}')">${header}</th>`).join('') +
                '</tr>';

            // Reset pagination
            currentPage = 1;

            // Update table
            updateTable();
        }

        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            const tableInfo = document.getElementById('tableInfo');
            const paginationControls = document.getElementById('paginationControls');

            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100" class="no-data-message">No matching records found</td></tr>';
                tableInfo.textContent = 'No data';
                paginationControls.style.display = 'none';
                return;
            }

            // Calculate pagination
            const totalRows = filteredData.length;
            const totalPages = rowsPerPage === 'all' ? 1 : Math.ceil(totalRows / rowsPerPage);
            const startIndex = rowsPerPage === 'all' ? 0 : (currentPage - 1) * rowsPerPage;
            const endIndex = rowsPerPage === 'all' ? totalRows : Math.min(startIndex + rowsPerPage, totalRows);

            // Get page data
            const pageData = filteredData.slice(startIndex, endIndex);

            // Generate table rows
            const headers = Object.keys(csvData[0]);
            tableBody.innerHTML = pageData.map(row => {
                return '<tr>' + headers.map(header => {
                    let value = row[header] || '';

                    // Apply status badge if it's the STATUS column
                    if (header === 'STATUS' && value) {
                        const statusClass = getStatusClass(value);
                        return `<td><span class="status-badge ${statusClass}">${value}</span></td>`;
                    }

                    return `<td title="${value}">${value}</td>`;
                }).join('') + '</tr>';
            }).join('');

            // Update info
            tableInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalRows} records`;

            // Update pagination
            if (rowsPerPage !== 'all' && totalPages > 1) {
                paginationControls.style.display = 'flex';
                document.getElementById('paginationInfo').textContent = `Page ${currentPage} of ${totalPages}`;

                // Update button states
                const buttons = document.querySelectorAll('.pagination-buttons button');
                buttons[0].disabled = currentPage === 1; // First
                buttons[1].disabled = currentPage === 1; // Previous
                buttons[2].disabled = currentPage === totalPages; // Next
                buttons[3].disabled = currentPage === totalPages; // Last
            } else {
                paginationControls.style.display = 'none';
            }
        }

        function getStatusClass(status) {
            if (!status) return 'status-default';
            if (status.includes('Confirm') || status.includes('Onboarding') || status.includes('Training')) return 'status-confirmed';
            if (status.includes('Rejected') || status.includes('Phone Not Received')) return 'status-rejected';
            if (status.includes('Scheduled') || status.includes('Top Priority')) return 'status-scheduled';
            if (status.includes('Done') || status.includes('Offer')) return 'status-done';
            return 'status-default';
        }

        function searchTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (searchTerm === '') {
                filteredData = [...csvData];
            } else {
                filteredData = csvData.filter(row => {
                    return Object.values(row).some(value =>
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }

            currentPage = 1;
            updateTable();
        }

        function sortTable(column) {
            // Toggle sort direction
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Sort the data
            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                // Try to parse as number
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }

                // String comparison
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();

                if (sortDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });

            // Update header styling
            document.querySelectorAll('#tableHeader th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            const headerCells = Array.from(document.querySelectorAll('#tableHeader th'));
            const columnIndex = Object.keys(csvData[0]).indexOf(column);
            if (columnIndex !== -1) {
                headerCells[columnIndex].classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }

            updateTable();
        }

        function changePage(action) {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);

            switch (action) {
                case 'first':
                    currentPage = 1;
                    break;
                case 'prev':
                    if (currentPage > 1) currentPage--;
                    break;
                case 'next':
                    if (currentPage < totalPages) currentPage++;
                    break;
                case 'last':
                    currentPage = totalPages;
                    break;
            }

            updateTable();
        }

        function changeRowsPerPage() {
            const select = document.getElementById('rowsPerPage');
            rowsPerPage = select.value === 'all' ? 'all' : parseInt(select.value);
            currentPage = 1;
            updateTable();
        }

        // Update the processData function to include raw data table
        const originalProcessData = processData;
        processData = function () {
            originalProcessData();
            displayRawDataTable();
        };
    </script>
</body>

</html>
